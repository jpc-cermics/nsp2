/* Nsp
 * Copyright (C) 2006 Bruno Pincon Esial/Iecn
 *
 * This library is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public
 * License as published by the Free Software Foundation; either
 * version 2 of the License, or (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public
 * License along with this library; if not, write to the
 * Free Software Foundation, Inc., 59 Temple Place - Suite 330,
 * Boston, MA 02111-1307, USA.
 */

/*    rejection ziggurat method for the normal distribution
 *    as explained in "Marsaglia G and WW Tsang,The Ziggurat 
 *    Method for Generating Random Variables
 *    Journal of Statistical Software, vol. 5 (2000), no. 8"
 *    (this paper together with a C implementation is available 
 *    at http://www.jstatsoft.org/v05/i08/)
 *
 *    Our implementation uses 128 rectangles and the current "base"
 *    generator of Nsp (which can be mt, kiss, clcg4, clcg2, fsultra
 *    and urand). The constants (x_k and y_k values) have been 
 *    calculated with the pari-gp software.
 */

#include "grand.h"
#include <math.h>

/* double rej_nor_A=1.01169574932439925; */
double rej_nor_coef=0.999999998980229122;
double rej_nor_x[128]={
    0.0                 ,0.272260335819100152,0.362789811234512105,0.426451045333789327,
    0.477328297638131970,0.520535516250065767,0.558561749888342673,0.592823377871994897,
    0.624210473482257302,0.653322402192557036,0.680583923441677467,0.706308142991286417,
    0.730733202454261189,0.754044908667612373,0.776391343832927813,0.797892660691528339,
    0.818647860822259661,0.838739613515366278,0.858237762302139282,0.877201928832491846,
    0.895683481284579274,0.913727046133528972,0.931371685746867106,0.948651827409168120,
    0.965598004717329353,0.982237455454556239,0.998594608349692044,1.01469148285872250,
    1.03054802017186728,1.04618235933330554,1.06161106918041182,1.07684934443869019,
    1.09191117252206728,1.10680947622827299,1.12155623647409692,1.13616259840535703,
    1.15063896358346606,1.16499507045205961,1.17924006489184375,1.19338256235618458,
    1.20743070282634620,1.22139219962029057,1.23527438292233782,1.24908423876485699,
    1.26282844408139425,1.27651339835847103,1.29014525233694693,1.30372993415037775,
    1.31727317323485565,1.33078052230051828,1.34425737761775095,1.35770899783986908,
    1.37114052155777725,1.38455698375996147,1.39796333135253770,1.41136443787842487,
    1.42476511756160731,1.43817013879154796,1.45158423715382861,1.46501212810579413,
    1.47845851939018268,1.49192812327528568,1.50542566870699028,1.51895591345602884,
    1.53252365634283981,1.54613374962260128,1.55979111161422215,1.57350073965938320,
    1.58726772350114597,1.60109725917625366,1.61499466352112076,1.62896538939876050,
    1.64301504176267692,1.65714939468423201,1.67137440948240938,1.68569625410950475,
    1.70012132396340772,1.71465626431719385,1.72930799458020000,1.74408373463218611,
    1.75899103350429292,1.77403780071813441,1.78923234063854772,1.80458339024751761,
    1.82010016080813566,1.83579238396003445,1.85167036287388286,1.86774502919512419,
    1.88402800662977127,1.90053168217222750,1.91726928615241328,1.93425498249406189,
    1.95150397083694680,1.96903260249456688,1.98685851261030046,2.00500077135846814,
    2.02348005763717476,2.04231885945012776,2.06154170611837686,2.08117543865815009,
    2.10124952618580602,2.12179643817150118,2.14285208490504440,2.16445634186234735,
    2.18665367805173851,2.20949391427752568,2.23303314516046058,2.25733486954208486,
    2.28247138881674128,2.30852555365333421,2.33559296935557232,2.36378481324130256,
    2.39323148104110405,2.42408737509113008,2.45653729459083076,2.49080512119574150,
    2.52716587199811729,2.56596282814359085,2.60763255663400993,2.65274266298927733,
    2.70205098406335352,2.75660281739636278,2.81790009135865477,2.88821806212574114,
    2.97125832511541854,3.07368882831867094,3.20959035241727022,3.41873728041066038
};
double rej_nor_y[128]={
    0.398942280401432678,0.384426994842451190,0.373533809867518554,0.364266775435218834,
    0.355987491469962614,0.348395432143697698,0.341320231377464721,0.334653934688922599,
    0.328322838546379638,0.322273854908996788,0.316467169818914587,0.310871968121166089,
    0.305463788353878454,0.300222805389373787,0.295132670688375813,0.290179703058151822,
    0.285352308142798275,0.280640552006427315,0.276035841407120021,0.271530679720963850,
    0.267118477639118362,0.262793404262423204,0.258550268486152127,0.254384423434663175,
    0.250291688671861619,0.246268286286977434,0.242310787931033449,0.238416070583387523,
    0.234581279342762599,0.230803795918824098,0.227081211786530318,0.223411305182409768,
    0.219792021288033674,0.216221455074356470,0.212697836380725580,0.209219516881082560,
    0.205784958652243506,0.202392724108911968,0.199041467110057461,0.195729925073616246,
    0.192456911962762127,0.189221312028501026,0.186022074211029914,0.182858207116920822,
    0.179728774501334507,0.176632891194601952,0.173569719421005169,0.170538465464737106,
    0.167538376644060996,0.164568738559813469,0.161628872588758189,0.158718133596024096,
    0.155835907844057719,0.152981611078267417,0.150154686771908885,0.147354604514813745,
    0.144580858532344777,0.141832966322512684,0.139110467400543723,0.136412922141373657,
    0.133739910711584959,0.131091032083221415,0.128465903122724314,0.125864157748951926,
    0.123285446154881531,0.120729434088161514,0.118195802186189339,0.115684245361847513,
    0.113194472236440934,0.110726204616751384,0.108279177013463733,0.105853136198528391,
    0.103447840799309967,0.101063060927636736,0.0986985778421129676,0.0963541836422895205,
    0.0940296809935106187,0.0917248828814690983,0.0894396123957117066,0.0871737025415429974,
    0.0849269960799839996,0.0826993453956532137,0.0804906123926559321,0.0783006684187970211,
    0.0761293942186762154,0.0739766799164882895,0.0718424250296385394,0.0697265385146031009,
    0.0676289388468211845,0.0655495541368112267,0.0634883222851660137,0.0614451911796161450,
    0.0594201189379729180,0.0574130742014907860,0.0554240364840508821,0.0534529965835919712,
    0.0514999570634431412,0.0495649328126939459,0.0476479516965372261,0.0457490553097210966,
    0.0438682998489586613,0.0420057571235103653,0.0401615157273649307,0.0383356824017557393,
    0.0365283836235058953,0.0347397674633701188,0.0329700057697905739,0.0312192967482265244,
    0.0294878680257630360,0.0277759803169419936,0.0260839318424645090,0.0244120637017349796,
    0.0227607664694759160,0.0211304883856878400,0.0195217456527766010,0.0179351355694870424,
    0.0163713535619080089,0.0148312156934036703,0.0133156890864266190,0.0118259341335865483,
    0.0103633649429580654,0.00892973928754678802,0.00752729903321789788,0.00615900327583668686,
    0.00482894843429243251,0.00354321759375052535,0.00231192758883694692,0.00115596379382906435
};

static double rand_nor_core()
{
  int k, positif;
  double u, v, y;
  while (1)
    {
      k = 0xff & rand_lgi();  /* a random integer in [0,255] k = b_7 2^7 + ... b_0^2  */    
      positif = k & 0x80;     /* take b_7 as the sign of the future output number */
      k &= 0x7f;              /* make b_7 = 0 for k : k is a random integer in [0,127] */

      if ( k < 127 )
	{
	  u = rej_nor_x[k+1]*rand_ranf();
	  if ( u <= rej_nor_x[k] )
	    break;
	  else
	    {
	      y = (rej_nor_y[k]-rej_nor_y[k+1])*rand_ranf() + rej_nor_y[k+1];
	      if ( y <= rej_nor_y[0]*exp(-0.5*u*u) )
		break;
	    }
	}
      else  /* k = 127 ie the bottom area  (one rectangle plus a gaussian tail) */
	{
	  double r = rej_nor_x[127]; 
	  v = rand_ranf();
	  if ( v <= rej_nor_coef )  /* generate in the rectangle */
	    {
	      u = r*rand_ranf();
	      break;
	    }
	  else                      /* generate in the tail  */
	    {
	      do
		{
		  /* using 1-rand_ranf() because rand_ranf() could output 0 but never 1 */
		  u = -log(1.0-rand_ranf())/r; v = -log(1.0-rand_ranf())/r;
		}
	      while ( u*u >= v*v );
	      u += r;
	      break;
	    }
	}
    }

  if ( positif )
    return u;
  else
    return -u;
}

double rand_nor(double mu, double sigma)
{
  return mu + sigma*rand_nor_core();
}
